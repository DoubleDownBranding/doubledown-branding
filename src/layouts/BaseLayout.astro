---
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    {Astro.slots.has('title')
      ? <slot name="title" />
      : <title>DoubleDown Branding</title>
    }

    <!-- ✅ Allow pages to inject head tags (e.g., canonical) -->
    <slot name="head" />

    <!-- ✅ Site-wide JSON-LD with canonical homepage URL -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "DoubleDown Branding",
      "url": "https://doubledownbranding.com/"
    }
    </script>

    <!-- GA4 (loads, but blocked until user accepts) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RJKTN58533"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }

      // Consent Mode v2: default to DENIED (nothing tracks until Accept)
      gtag('consent', 'default', {
        ad_storage: 'denied',
        analytics_storage: 'denied',
        ad_user_data: 'denied',
        ad_personalization: 'denied',
        security_storage: 'granted'
      });

      gtag('js', new Date());
      gtag('config', 'G-RJKTN58533', { anonymize_ip: true });
    </script>

    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <meta name="theme-color" content="#0D1A5A" />

    <link rel="stylesheet" href="/styles/global.css" />
  </head>

  <body style="font-family: 'Gotham', sans-serif; margin: 0; padding: 0; background: var(--paper);">
    <style>
      :root {
        --ink: #0D1A5A;
        --paper: #f6e4cc;
        --accent: #ef3741;
        /* will be set dynamically from the header script; fallback provided below */
        --dd-header-h: clamp(96px, 12vw, 160px);
      }

      /* Hardening + prevent horizontal scroll */
      *, *::before, *::after { box-sizing: border-box; }
      html, body { overflow-x: hidden; width: 100%; }

      /* Page shell so footer stays at the bottom on short pages */
      body {
        min-height: 100vh;
        display: grid;
        grid-template-rows: auto 1fr auto;
      }
      img { display: block; max-width: 100%; height: auto; }
    </style>

    <Header />

    <!-- Measure the real header height and store it in --dd-header-h -->
    <script is:inline>
      (function () {
        const root = document.documentElement;
        const nav  = document.querySelector('nav');
        function setHeaderVar() {
          if (!nav) return;
          const h = nav.offsetHeight || 96;
          root.style.setProperty('--dd-header-h', h + 'px');
        }
        setHeaderVar();
        window.addEventListener('resize', setHeaderVar, { passive: true });
        if (document.fonts && document.fonts.ready) {
          document.fonts.ready.then(setHeaderVar);
        }
      })();
    </script>

    <main id="main" role="main" tabindex="-1">
      <slot />
    </main>

    <Footer />

    <!-- Consent banner -->
    <style>
      #dd-consent[hidden] { display: none !important; }
      #dd-consent {
        position: fixed; left: 0; right: 0; bottom: 0; z-index: 99999;
        background: rgba(0,0,0,.25);
        display: flex; justify-content: center; align-items: flex-end;
      }
      #dd-consent .ddc-box {
        background: #0D1A5A; color: #f6e4cc;
        margin: 8px; padding: 16px;
        border: 1px solid rgba(255,255,255,.15);
        border-radius: 4px; max-width: 680px; width: calc(100% - 16px);
        font-family: 'Gotham', sans-serif;
      }
      #dd-consent p { margin: 0; line-height: 1.5; }
      #dd-consent .ddc-actions { display: flex; gap: 10px; margin-top: 12px; }
      #dd-consent button {
        cursor: pointer; border-radius: 2px; font-weight: 700;
        border: 2px solid transparent; padding: 10px 14px;
      }
      #dd-accept { background: #ef3741; color: #f6e4cc; }
      #dd-reject { background: transparent; color: #f6e4cc; border-color: #f6e4cc; }
    </style>

    <div id="dd-consent" hidden>
      <div class="ddc-box">
        <p>We use Google Analytics to understand traffic. You can accept or reject analytics cookies.</p>
        <div class="ddc-actions">
          <button id="dd-accept" type="button">Accept</button>
          <button id="dd-reject" type="button">Reject</button>
        </div>
      </div>
    </div>

    <script is:inline>
      (function () {
        var KEY = 'dd-consent-v1';
        var banner = document.getElementById('dd-consent');
        var saved = null;

        try { saved = localStorage.getItem(KEY); } catch (e) {}

        function accept() {
          gtag('consent','update', {
            ad_storage: 'granted',
            analytics_storage: 'granted',
            ad_user_data: 'granted',
            ad_personalization: 'granted'
          });
          try { localStorage.setItem(KEY, 'granted'); } catch (e) {}
          banner.hidden = true;
        }
        function reject() {
          gtag('consent','update', {
            ad_storage: 'denied',
            analytics_storage: 'denied',
            ad_user_data: 'denied',
            ad_personalization: 'denied'
          });
          try { localStorage.setItem(KEY, 'denied'); } catch (e) {}
          banner.hidden = true;
        }

        if (!saved) banner.hidden = false;

        document.addEventListener('click', function (e) {
          var t = e.target;
          if (t && t.id === 'dd-accept') accept();
          if (t && t.id === 'dd-reject') reject();
        });

        // Respect previous choice on load
        if (saved === 'granted') accept();
        if (saved === 'denied') reject();

        // Optional: reopen from a footer link via window.ddOpenConsent()
        window.ddOpenConsent = function () {
          try { localStorage.removeItem(KEY); } catch (e) {}
          banner.hidden = false;
          gtag('consent','update', { analytics_storage: 'denied', ad_storage: 'denied' });
        };
      })();
    </script>
  </body>
</html>
